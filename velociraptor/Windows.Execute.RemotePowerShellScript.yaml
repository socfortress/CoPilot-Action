name: Windows.Execute.RemotePowerShellScript
description: |
  Downloads and executes a specified PowerShell script from a GitHub repository.
  Supports up to 6 arguments, injected directly as variables for the script.
  Captures stdout/stderr/status and returns the OSSEC active-responses.log.
author: socfortress
type: CLIENT

parameters:
  - name: RepoURL
    type: string
    default: https://raw.githubusercontent.com/socfortress/WINDOWS-FIREWALL-IP-UNBLOCK-ACTIVERESPONSE/main
    description: Base URL of the raw GitHub repository.

  - name: ScriptName
    type: string
    default: firewall-ip-unblock.ps1
    description: PowerShell script filename to fetch and execute.

  - name: Arg1
    type: string
    default: ""
    description: Optional first argument (maps to $Arg1 in the script).

  - name: Arg2
    type: string
    default: ""
  - name: Arg3
    type: string
    default: ""
  - name: Arg4
    type: string
    default: ""
  - name: Arg5
    type: string
    default: ""
  - name: Arg6
    type: string
    default: ""

sources:
  - name: ScriptExecution
    description: Download, save, and execute the PowerShell script with dynamic arguments.
    query: |
      LET script_url = RepoURL + ScriptName

      SELECT timestamp(epoch=now()),
             Stdout,
             Stderr,
             Status,
             script_url AS SourceScript
      FROM execve(
        argv=[
          "powershell.exe",
          "-ExecutionPolicy","Bypass",
          "-NoProfile",
          "-Command",
          "$script = Invoke-RestMethod -Uri '" + script_url + "'; " +
          "$temp = Join-Path $env:TEMP '" + ScriptName + "'; " +
          "Set-Content -Path $temp -Value $script -Force; " +
          "$Arg1='" + Arg1 + "'; " +
          "$Arg2='" + Arg2 + "'; " +
          "$Arg3='" + Arg3 + "'; " +
          "$Arg4='" + Arg4 + "'; " +
          "$Arg5='" + Arg5 + "'; " +
          "$Arg6='" + Arg6 + "'; " +
          "& $temp"
        ]
      )

  - name: CollectedLogs
    description: Return the full active-responses.log for offline filtering.
    query: |
      SELECT timestamp(epoch=now()),
             read_file(filename="C:/Program Files (x86)/ossec-agent/active-response/active-responses.log") AS LogContent
      FROM scope()
