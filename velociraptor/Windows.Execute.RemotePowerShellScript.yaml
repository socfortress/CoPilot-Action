name: Windows.Execute.RemotePowerShellScript
description: |
  Downloads and executes a specified PowerShell script from a full raw URL.
  Supports up to 6 arguments, injected directly as variables for the script.
  Captures stdout/stderr/status and returns the OSSEC active-responses.log.
author: socfortress
type: CLIENT

parameters:
  - name: ScriptURL
    type: string
    default: https://raw.githubusercontent.com/socfortress/WINDOWS-FIREWALL-IP-UNBLOCK-ACTIVERESPONSE/main/firewall-ip-unblock.ps1
    description: Full raw URL to the PowerShell script (e.g., GitHub raw link).

  - name: Arg1
    type: string
    default: ""
    description: Optional first argument (maps to $Arg1 in the script).
  - name: Arg2
    type: string
    default: ""
  - name: Arg3
    type: string
    default: ""
  - name: Arg4
    type: string
    default: ""
  - name: Arg5
    type: string
    default: ""
  - name: Arg6
    type: string
    default: ""

sources:
  - name: ScriptExecution
    description: Download, save, and execute the PowerShell script from a full URL with dynamic arguments.
    query: |
      SELECT timestamp(epoch=now()),
             Stdout,
             Stderr,
             Status,
             ScriptURL AS SourceScript
      FROM execve(
        argv=[
          "powershell.exe",
          "-ExecutionPolicy","Bypass",
          "-NoProfile",
          "-Command",
          "$url = '" + ScriptURL + "'; " +
          "$script = Invoke-RestMethod -Uri $url; " +
          "$name = [System.IO.Path]::GetFileName(([System.Uri]$url).AbsolutePath); " +
          "if (-not $name) { $name = 'remote.ps1' }; " +
          "$temp = Join-Path $env:TEMP $name; " +
          "Set-Content -Path $temp -Value $script -Force; " +
          "$Arg1='" + Arg1 + "'; " +
          "$Arg2='" + Arg2 + "'; " +
          "$Arg3='" + Arg3 + "'; " +
          "$Arg4='" + Arg4 + "'; " +
          "$Arg5='" + Arg5 + "'; " +
          "$Arg6='" + Arg6 + "'; " +
          "& $temp"
        ]
      )

  - name: CollectedLogs
    description: Return the full active-responses.log for offline filtering.
    query: |
      SELECT timestamp(epoch=now()),
             read_file(filename="C:/Program Files (x86)/ossec-agent/active-response/active-responses.log") AS LogContent
      FROM scope()
