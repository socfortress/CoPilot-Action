name: Linux.Execute.RemoteBashScript
description: |
  Downloads and executes a Bash script from a full raw URL.
  Supports up to 6 arguments, exported as environment variables (ARG1â€“ARG6).
  Always runs via `bash` explicitly to avoid shebang or CRLF issues.
  Captures stdout, stderr, exit status, and the full active-responses.log for later processing.
author: socfortress
type: CLIENT

parameters:
  - name: ScriptURL
    type: string
    description: Full raw URL to the Bash script (e.g., GitHub raw link)
    default: https://raw.githubusercontent.com/socfortress/Repo-to-hold-linux-activeresponse/main/collect-suspicious-users-groups.sh

  - name: Arg1
    type: string
    default: ""
    description: Optional first argument (exported as ARG1).
  - name: Arg2
    type: string
    default: ""
  - name: Arg3
    type: string
    default: ""
  - name: Arg4
    type: string
    default: ""
  - name: Arg5
    type: string
    default: ""
  - name: Arg6
    type: string
    default: ""

sources:
  - name: ScriptExecution
    description: Download to a temp file, export arguments, and run the Bash script explicitly.
    query: |
      SELECT timestamp(epoch=now()),
             Stdout,
             Stderr,
             Status,
             ScriptURL AS SourceScript
      FROM execve(
        argv=[
          "bash",
          "-c",
          "set -euo pipefail; " +
          "tmp=$(mktemp /tmp/remote-XXXXXX.sh); " +
          "curl -fsSL '" + ScriptURL + "' -o \"$tmp\"; " +
          "chmod +x \"$tmp\"; " +
          "export ARG1='" + Arg1 + "' ARG2='" + Arg2 + "' ARG3='" + Arg3 + "' ARG4='" + Arg4 + "' ARG5='" + Arg5 + "' ARG6='" + Arg6 + "'; " +
          "bash \"$tmp\""
        ]
      )

  - name: CollectedLogs
    description: Return the full active-responses.log for offline processing.
    query: |
      SELECT timestamp(epoch=now()),
             read_file(filename="/var/ossec/logs/active-responses.log") AS LogContent
      FROM scope()
